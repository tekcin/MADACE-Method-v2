# CLI Integration in MADACE-Method v2.0

**Status**: Planned for Implementation
**Priority**: High
**Version**: 2.0.0-alpha

---

## Overview

MADACE-Method v2.0 **maintains full CLI functionality** while adding a modern Web UI. Both interfaces work simultaneously with the same underlying state and files.

### Key Principle

> **"CLI-First, Web-Enhanced"** - All functionality available via CLI is also available via Web UI, and vice versa.

---

## Architecture

### Dual Interface Design

```
┌────────────────────────────────────────────────────────────┐
│                  MADACE-Method v2.0                         │
│                                                             │
│  ┌──────────────────┐              ┌──────────────────┐   │
│  │    Web UI        │              │    CLI           │   │
│  │   (Browser)      │              │  (Terminal)      │   │
│  │                  │              │                  │   │
│  │  • Visual Forms  │              │  • Text Prompts  │   │
│  │  • Kanban Board  │              │  • Status Text   │   │
│  │  • Real-time UI  │              │  • Claude/Gemini │   │
│  └────────┬─────────┘              └────────┬─────────┘   │
│           │                                 │              │
│           └────────────┬────────────────────┘              │
│                        ▼                                    │
│           ┌────────────────────────┐                       │
│           │  TypeScript Business   │                       │
│           │       Logic Layer      │                       │
│           │                        │                       │
│           │  • Agent Loader        │                       │
│           │  • Workflow Engine     │                       │
│           │  • State Machine       │                       │
│           │  • Template Engine     │                       │
│           │  • LLM Client          │                       │
│           └────────────┬───────────┘                       │
│                        ▼                                    │
│           ┌────────────────────────┐                       │
│           │    File System         │                       │
│           │                        │                       │
│           │  • Agent YAML files    │                       │
│           │  • Workflow YAML files │                       │
│           │  • Status markdown     │                       │
│           │  • Story files         │                       │
│           │  • Configuration       │                       │
│           └────────────────────────┘                       │
└────────────────────────────────────────────────────────────┘
```

**Benefits:**

- Both interfaces use **identical business logic**
- No code duplication
- Changes in one interface immediately available in the other
- Developer can choose preferred interface

---

## Supported CLIs

### 1. Claude CLI (Anthropic)

**Installation:**

```bash
npm install -g @anthropic-ai/claude-cli
claude --version  # Verify: v2.0.21+
```

**Configuration:**

```typescript
// .claude.json (auto-generated by MADACE)
{
  "project": "madace-method-v2",
  "context": {
    "agents_path": "madace/mam/agents",
    "workflows_path": "madace/mam/workflows",
    "status_file": "docs/mam-workflow-status.md"
  },
  "llm": {
    "provider": "anthropic",
    "model": "claude-3-5-sonnet-20241022",
    "apiKey": "${CLAUDE_API_KEY}"
  }
}
```

**Usage:**

```bash
# Load agent
claude --project madace-method-v2 agent pm

# Execute workflow
claude --project madace-method-v2 workflow plan-project

# Check status
claude --project madace-method-v2 state show
```

### 2. Gemini CLI (Google)

**Installation:**

```bash
npm install -g @google/generative-ai-cli
gemini --version  # Verify installation
```

**Configuration:**

```typescript
// .gemini.json (auto-generated by MADACE)
{
  "project": "madace-method-v2",
  "context": {
    "agents_path": "madace/mam/agents",
    "workflows_path": "madace/mam/workflows",
    "status_file": "docs/mam-workflow-status.md"
  },
  "llm": {
    "provider": "google",
    "model": "gemini-2.0-flash-exp",
    "apiKey": "${GEMINI_API_KEY}"
  }
}
```

**Usage:**

```bash
# Load agent
gemini --project madace-method-v2 agent pm

# Execute workflow
gemini --project madace-method-v2 workflow plan-project

# Check status
gemini --project madace-method-v2 state show
```

---

## Implementation Plan

### Phase 1: CLI Adapter Layer (Week 3)

**File**: `lib/cli/adapter.ts`

```typescript
export interface CLIAdapter {
  provider: 'claude' | 'gemini';
  initialize(config: Config): Promise<void>;
  loadAgent(agentId: string): Promise<void>;
  executeWorkflow(workflowName: string): Promise<void>;
  showState(): Promise<WorkflowStatus>;
}
```

**Implementation:**

- `lib/cli/claude.ts` - Claude CLI adapter
- `lib/cli/gemini.ts` - Gemini CLI adapter
- `lib/cli/sync.ts` - File-based sync service

### Phase 2: State Synchronization (Week 3)

**File**: `lib/sync/cli-sync.ts`

```typescript
// Watch for CLI changes to status file
const watcher = fs.watch('docs/mam-workflow-status.md');

watcher.on('change', async () => {
  // Reload state
  const newState = await loadStateMachine();

  // Notify web clients via WebSocket
  webSocketServer.broadcast({
    type: 'state_updated',
    state: newState,
  });
});
```

**Features:**

- Real-time sync from CLI → Web UI
- Real-time sync from Web UI → CLI
- WebSocket for instant updates
- Polling fallback (every 2 seconds)

### Phase 3: Configuration Generation (Week 3)

**Auto-generate CLI configs from Web UI:**

```typescript
// lib/config/cli-config-generator.ts

export async function generateCLIConfigs(config: Config): Promise<void> {
  // Generate .claude.json
  await writeCla udeConfig(config);

  // Generate .gemini.json
  await writeGeminiConfig(config);

  // Update .gitignore (don't commit API keys)
  await updateGitIgnore(['.claude.json', '.gemini.json']);
}
```

---

## Usage Examples

### Example 1: Planning via CLI, Implementation via Web

```bash
# Terminal: Use Claude CLI for planning
claude --project madace-method-v2 agent pm
claude --project madace-method-v2 workflow plan-project
# PRD.md generated in docs/

# Browser: View generated PRD
http://localhost:3000/docs/PRD.md

# Browser: Continue with implementation in Web UI
# Open SM agent → Create stories → Visual Kanban board
```

### Example 2: Mix and Match

```bash
# Terminal 1: Start story creation via Gemini CLI
gemini --project madace-method-v2 agent sm
gemini --project madace-method-v2 workflow create-story

# Browser: Monitor progress in real-time
# Kanban board updates automatically

# Terminal 2: Watch status file
watch -n 2 'cat docs/mam-workflow-status.md'

# All three stay in sync!
```

### Example 3: Pure CLI Workflow

```bash
# Complete project using only CLI
claude --project madace-method-v2 agent pm
claude --project madace-method-v2 workflow plan-project

claude --project madace-method-v2 agent sm
claude --project madace-method-v2 workflow create-story

claude --project madace-method-v2 agent dev
claude --project madace-method-v2 workflow dev-story

# Web UI optional - all functionality available via CLI
```

---

## State Synchronization

### File-Based Sync Strategy

**Single Source of Truth:**

```
docs/mam-workflow-status.md  ← Both CLI and Web UI read/write this file
```

**Sync Flow:**

```
CLI modifies status file
       ↓
File system watcher detects change
       ↓
State Machine reloads from file
       ↓
WebSocket broadcasts update
       ↓
Web UI updates Kanban board

(And vice versa)
```

### Conflict Resolution

**No conflicts possible:**

- Both interfaces use same TypeScript business logic
- State Machine enforces rules (one TODO, one IN PROGRESS)
- File-based locking prevents concurrent writes
- Atomic operations ensure consistency

---

## API Compatibility

### CLI Commands → API Endpoints

| CLI Command             | Web UI Action          | API Endpoint                  |
| ----------------------- | ---------------------- | ----------------------------- |
| `agent pm`              | Click "PM Agent"       | `GET /api/agents/pm`          |
| `workflow plan-project` | Click "\*plan-project" | `POST /api/workflows/execute` |
| `state show`            | View Kanban board      | `GET /api/state`              |
| `story-ready`           | Move TODO→IN PROGRESS  | `POST /api/state/transition`  |

**Same TypeScript functions called:**

```typescript
// lib/agents/loader.ts
export async function loadAgent(id: string): Promise<Agent>;

// CLI calls it:
const agent = await loadAgent('pm');

// Web UI calls it:
const agent = await loadAgent('pm');

// Same function, same result!
```

---

## Implementation Checklist

### Week 3: CLI Integration

**CLI Adapters:**

- [ ] `lib/cli/adapter.ts` - Base adapter interface
- [ ] `lib/cli/claude.ts` - Claude CLI adapter
- [ ] `lib/cli/gemini.ts` - Gemini CLI adapter
- [ ] `lib/cli/config-generator.ts` - Generate .claude.json, .gemini.json

**Synchronization:**

- [ ] `lib/sync/cli-sync.ts` - File watcher + WebSocket broadcast
- [ ] `lib/sync/state-sync.ts` - Bidirectional state sync
- [ ] `lib/sync/polling-fallback.ts` - Polling if WebSocket fails

**Testing:**

- [ ] Test CLI → Web UI sync
- [ ] Test Web UI → CLI sync
- [ ] Test simultaneous usage
- [ ] Test conflict scenarios (should never happen)

**Documentation:**

- [x] CLI-INTEGRATION.md (this file)
- [ ] Update ARCHITECTURE.md with CLI details
- [ ] Update README.md with CLI examples
- [ ] Create CLI tutorial video

---

## Developer Experience

### For CLI Users

**Advantages:**

- ✅ Familiar command-line interface
- ✅ Scriptable workflows
- ✅ No browser required
- ✅ Fast keyboard-driven interaction
- ✅ Terminal multiplexer friendly (tmux/screen)

**Example tmux setup:**

```bash
# Window 1: Claude CLI
tmux new-session -s madace
claude --project madace-method-v2 agent pm

# Window 2: Watch status
tmux split-window -h
watch -n 2 'cat docs/mam-workflow-status.md'

# Window 3: Edit files
tmux split-window -v
vim docs/PRD.md
```

### For Web UI Users

**Advantages:**

- ✅ Visual Kanban board
- ✅ Point-and-click interface
- ✅ Real-time progress indicators
- ✅ No CLI tools to install
- ✅ Accessible from any device with browser

### For Hybrid Users

**Best of Both Worlds:**

- Use CLI for repetitive tasks (scriptable)
- Use Web UI for visual overview (Kanban)
- Switch between interfaces mid-workflow
- CLI for focused work, Web UI for monitoring

---

## Testing Strategy

### CLI Integration Tests

```typescript
// tests/cli/claude-integration.test.ts

describe('Claude CLI Integration', () => {
  it('should load agent via CLI', async () => {
    const result = await execCLI('claude --project madace agent pm');
    expect(result.agent.name).toBe('PM');
  });

  it('should sync state from CLI to Web UI', async () => {
    // Execute workflow via CLI
    await execCLI('claude --project madace workflow create-story');

    // Check Web UI received update
    const state = await fetch('http://localhost:3000/api/state');
    expect(state.inProgress).toBeDefined();
  });

  it('should handle simultaneous CLI and Web UI usage', async () => {
    // Start workflow in Web UI
    await fetch('http://localhost:3000/api/workflows/execute', {
      method: 'POST',
      body: JSON.stringify({ workflow: 'plan-project' }),
    });

    // Check status via CLI
    const result = await execCLI('claude --project madace state show');
    expect(result.currentWorkflow).toBe('plan-project');
  });
});
```

---

## Troubleshooting

### CLI Not Syncing

**Check file watcher:**

```bash
# Verify file watcher is running
curl http://localhost:3000/api/health/watcher
```

**Manual sync:**

```bash
# Force refresh web UI
curl -X POST http://localhost:3000/api/sync/force
```

### Config Files Not Generated

**Regenerate configs:**

```typescript
// Via Web UI: Settings → Advanced → Regenerate CLI Configs
// Or via API:
curl -X POST http://localhost:3000/api/config/regenerate-cli
```

### API Key Issues

**CLI uses same API keys as Web UI:**

```bash
# Check .env file
cat .env | grep API_KEY

# Or check via Web UI: Settings → LLM
```

---

## Future Enhancements

### Phase 4: Advanced CLI Features (v2.1+)

- [ ] `madace` unified CLI (wraps Claude/Gemini)
- [ ] Tab completion for bash/zsh
- [ ] CLI dashboard (terminal UI with blessed.js)
- [ ] Offline mode (queue commands when offline)
- [ ] CLI-specific shortcuts
- [ ] Voice commands (experimental)

### Example: Unified CLI

```bash
# Instead of:
claude --project madace-method-v2 agent pm

# Use:
madace agent pm

# Auto-detects LLM from config
# Works with Claude, Gemini, or local model
```

---

## Conclusion

MADACE-Method v2.0 provides **full CLI support** alongside the new Web UI:

✅ **No Functionality Lost** - Everything available via CLI
✅ **Seamless Integration** - CLI and Web UI work together
✅ **Developer Choice** - Use CLI, Web UI, or both
✅ **Same Business Logic** - No code duplication
✅ **Real-Time Sync** - Changes propagate instantly
✅ **Battle-Tested** - Uses proven CLI tools (Claude, Gemini)

**The Web UI enhances, rather than replaces, the CLI experience.**

---

**Document Version**: 1.0
**Last Updated**: 2025-10-20
**Status**: Implementation Planned for Week 3
