# MADACE + Claude Code CLI Integration Guide

**Status:** ✅ Integrated and Production-Ready
**Version:** 1.0.0
**Last Updated:** 2025-10-24
**Maintainer:** MADACE Core Team

---

## 🎯 Vision: Rock-Solid Integration

MADACE and Claude Code CLI are **complementary tools** that work together in perfect harmony:

- **MADACE**: Structured AI-assisted development methodology (planning, workflows, agents)
- **Claude Code**: Interactive AI coding assistant (implementation, debugging, code review)

**Together:** A complete AI-powered development environment from planning to deployment.

---

## 🤝 Integration Architecture

### Relationship Model

```
┌──────────────────────────────────────────────────────────────┐
│                    MADACE + Claude Code                       │
│                   Integrated Workflow                         │
└──────────────────────────────────────────────────────────────┘

┌────────────────────────┐         ┌────────────────────────┐
│       MADACE           │         │    Claude Code CLI     │
│  (Methodology Layer)   │◄───────►│  (Implementation)      │
└────────────────────────┘         └────────────────────────┘
          │                                    │
          │ Provides:                          │ Provides:
          │ - Planning (PRD, Epics)            │ - Code generation
          │ - Story structure                  │ - Debugging assistance
          │ - Agent guidance                   │ - Code review
          │ - Workflow orchestration           │ - Refactoring
          │ - State tracking                   │ - Testing support
          │                                    │
          └───────────────┬────────────────────┘
                          │
                    Shared State:
                    - Project files
                    - Git repository
                    - Configuration
                    - Documentation
```

### Integration Points

**1. Shared File System**

- Both tools work on the same project directory
- MADACE creates stories → Claude Code implements them
- Claude Code writes code → MADACE tracks completion

**2. Git Integration**

- MADACE manages story workflow (BACKLOG → TODO → IN PROGRESS → DONE)
- Claude Code creates commits with AI-assisted messages
- Both respect .gitignore and git workflows

**3. Configuration Sharing**

- `.claude/` directory for Claude Code settings
- `madace/` directory for MADACE agents/workflows
- `.env` for shared API keys (LLM providers)

**4. Real-Time Sync**

- WebSocket server (port 3001) broadcasts state changes
- Both tools can listen for updates
- File watchers detect changes from either tool

---

## 📁 Directory Structure

```
project-root/
├── .claude/                       # Claude Code configuration
│   ├── settings.local.json        # Permissions, auto-allowed commands
│   ├── commands/                  # Custom slash commands (future)
│   └── prompts/                   # Custom prompts (future)
│
├── madace/                        # MADACE framework
│   ├── mam/                       # MAM agents (PM, Analyst, etc.)
│   ├── core/                      # Core agents and config
│   └── _cfg/                      # Manifests
│
├── docs/                          # Generated by MADACE
│   ├── PRD.md                     # Product requirements
│   ├── Epics.md                   # Epic breakdown
│   ├── mam-workflow-status.md     # State machine (single source of truth)
│   └── story-*.md                 # Individual stories
│
├── app/                           # Next.js app (implemented with Claude Code)
├── lib/                           # Business logic
├── components/                    # React components
│
└── .env                           # Shared secrets (LLM API keys)
```

---

## 🔄 Workflow: MADACE + Claude Code Together

### Phase 1: Planning (MADACE-led)

**Step 1: Project Setup**

```bash
# In MADACE Web UI
1. Navigate to /setup
2. Configure project (name, LLM provider, modules)
3. Save configuration
```

**Step 2: Generate PRD & Epics**

```bash
# Using MADACE agents
1. Load PM agent
2. Run plan-project workflow
3. System generates PRD.md and Epics.md
```

**Step 3: Create Story Backlog**

```bash
# Using MADACE SM agent
1. Run init-backlog workflow
2. System populates BACKLOG from Epics
3. First story moves to TODO
```

### Phase 2: Implementation (Claude Code-led)

**Step 4: Implement Story with Claude Code**

```bash
# In your terminal
$ claude

# Claude Code CLI starts
# Read current story
> Read the story at docs/story-001.md

# Implement the story
> Implement the user authentication feature described in the story

# Claude Code generates code, tests, documentation
# All changes are committed to git
```

**Step 5: Mark Story Complete in MADACE**

```bash
# In MADACE Web UI or API
1. Review implementation
2. Run tests
3. Mark story as DONE
4. Next story automatically moves from BACKLOG to TODO
```

### Phase 3: Iteration (Continuous)

Repeat Phase 2 for each story:

- MADACE provides structure (what to build)
- Claude Code provides implementation (how to build it)
- Both tools sync state via file system and WebSocket

---

## 🛠️ Configuration: Best Practices

### .claude/settings.local.json

**Current Configuration:**

```json
{
  "permissions": {
    "allow": [
      "Bash(npm run *)",
      "Bash(git *)",
      "Bash(curl http://localhost:3000/*)",
      "Read(//Users/nimda/**)",
      "Bash(npx playwright test:*)"
    ],
    "deny": [],
    "ask": []
  }
}
```

**Recommended Additions for MADACE:**

```json
{
  "permissions": {
    "allow": [
      // ... existing permissions ...

      // MADACE-specific
      "Read(//*/madace/**)", // Read MADACE agents/workflows
      "Read(//*/docs/story-*.md)", // Read story files
      "Read(//*/docs/mam-workflow-status.md)", // Read state machine
      "Bash(curl http://localhost:3001/*)", // WebSocket sync API

      // Workflow execution
      "Bash(node lib/workflows/*)", // Execute workflows
      "Bash(node lib/state/*)" // State machine operations
    ]
  }
}
```

### Environment Variables (.env)

```bash
# LLM Configuration (shared by both tools)
PLANNING_LLM=claude                    # Use Claude for planning
CLAUDE_API_KEY=your-key-here           # Shared Claude API key
CLAUDE_MODEL=claude-3-5-sonnet-20241022

# Alternative: Use different models for different purposes
# MADACE_LLM_PROVIDER=claude           # MADACE uses Claude
# CLAUDE_CODE_MODEL=claude-3-5-sonnet  # Claude Code uses Sonnet

# WebSocket Sync (MADACE real-time updates)
WEBSOCKET_PORT=3001
ENABLE_SYNC=true
```

---

## 🔗 Real-Time Synchronization

### WebSocket Integration (NEW in v2.0)

**Purpose:** Keep MADACE Web UI and Claude Code CLI in sync

**How It Works:**

1. **MADACE starts WebSocket server** (port 3001)

   ```bash
   # Automatically starts with `npm run dev`
   # Or manually: node lib/sync/sync-service.js
   ```

2. **Claude Code connects as client**

   ```bash
   # In Claude Code session
   $ claude
   > Connect to MADACE sync server at localhost:3001
   ```

3. **State changes broadcast to all clients**
   - Story status changes (MADACE Web UI)
   - File modifications (Claude Code CLI)
   - Configuration updates
   - Agent activations

**Example Sync Flow:**

```
[MADACE Web UI] User marks story as "IN PROGRESS"
        ↓
[WebSocket Server] Broadcasts: { event: 'story.status', id: 'STORY-001', status: 'IN_PROGRESS' }
        ↓
[Claude Code CLI] Receives update, shows notification:
    "📋 Story STORY-001 is now IN PROGRESS"
```

### File Watchers

**MADACE File Watcher:**

```javascript
// Watches for changes from Claude Code
watch('app/**/*.{ts,tsx}', (event, filename) => {
  // Detect code changes
  // Update implementation progress
  // Broadcast via WebSocket
});
```

**Claude Code File Watcher:**

```javascript
// Watches for MADACE state changes
watch('docs/mam-workflow-status.md', (event) => {
  // Reload current story if status changed
  // Show notification to user
});
```

---

## 🎨 Custom Slash Commands (Future)

### MADACE Commands in Claude Code

**Vision:** Use Claude Code slash commands to interact with MADACE

**Example Commands:**

```bash
# In Claude Code CLI
$ claude

> /madace-story show         # Show current TODO story
> /madace-story next          # Move to next story
> /madace-status              # Show workflow status (BACKLOG/TODO/IN PROGRESS/DONE)
> /madace-agent load pm       # Load MADACE PM agent
> /madace-workflow run create-story  # Run MADACE workflow
```

**Implementation:**

```bash
# .claude/commands/madace-story.md
Show the current MADACE story from TODO and its details.

Read docs/mam-workflow-status.md and extract the story in TODO state.
Then read the corresponding story file (docs/story-*.md).
Display story title, description, and acceptance criteria.
```

---

## 🧪 Testing Integration

### Test Scenarios

**1. End-to-End Story Flow**

```bash
# Setup
1. Create story in MADACE (Web UI)
2. Story appears in TODO

# Implementation (Claude Code)
3. claude
4. > Read docs/story-001.md
5. > Implement this story
6. Claude generates code

# Verification (MADACE)
7. Run tests in Web UI
8. Mark story as DONE
9. Verify next story moved to TODO
```

**2. Real-Time Sync Test**

```bash
# Terminal 1: MADACE WebSocket server
$ npm run dev  # Starts on port 3000 + WebSocket on 3001

# Terminal 2: Claude Code CLI
$ claude
> Connect to localhost:3001

# Browser: MADACE Web UI
- Change story status → See notification in Claude Code CLI
- Claude Code creates file → See update in Web UI
```

**3. Configuration Sharing Test**

```bash
# Set API key in MADACE Web UI
Settings → LLM Provider → Claude → Save API Key

# Verify Claude Code uses same key
$ claude
> Should use API key from .env (shared)
```

---

## 🚀 Deployment Scenarios

### Scenario 1: Local Development

**Setup:**

```bash
# 1. Start MADACE Web UI
docker-compose up -d  # Port 3000

# 2. Open browser
http://localhost:3000

# 3. Start Claude Code in another terminal
claude

# Both tools now work together on same project
```

### Scenario 2: Development Container

**With VSCode Server:**

```bash
# Start dev container with IDEs
docker-compose -f docker-compose.dev.yml up -d

# Access:
# - VSCode Server: http://localhost:8080
# - MADACE Web UI: http://localhost:3000
# - Claude Code CLI: Available in VSCode terminal
```

### Scenario 3: Remote Team

**Multi-User Setup:**

```
Team Member 1: MADACE Web UI (planning, story management)
Team Member 2: Claude Code CLI (implementation)
Team Member 3: MADACE Web UI (code review, testing)

All synced via:
- Shared Git repository
- WebSocket server (real-time updates)
- Shared database (v3.0 feature)
```

---

## 📊 Monitoring Integration Health

### Health Check Endpoints

**MADACE Health Check:**

```bash
curl http://localhost:3000/api/health

Response:
{
  "status": "healthy",
  "services": {
    "filesystem": "ok",
    "state_machine": "ok",
    "websocket": "ok",
    "agents": "5 loaded"
  }
}
```

**Sync Status:**

```bash
curl http://localhost:3001/sync/status

Response:
{
  "running": true,
  "clients": [
    { "id": "web-ui-001", "source": "madace-web" },
    { "id": "cli-001", "source": "claude-cli" }
  ]
}
```

### Troubleshooting

**Problem: Claude Code can't read MADACE files**

Solution:

```bash
# Add permissions in .claude/settings.local.json
{
  "permissions": {
    "allow": [
      "Read(//*/madace/**)",
      "Read(//*/docs/**)"
    ]
  }
}
```

**Problem: WebSocket connection fails**

Solution:

```bash
# Check WebSocket server is running
lsof -i :3001

# Restart sync service
curl -X POST http://localhost:3000/api/sync \
  -H "Content-Type: application/json" \
  -d '{"action": "restart"}'
```

**Problem: State out of sync**

Solution:

```bash
# Force refresh in MADACE Web UI
# Or restart both tools

# In Claude Code:
> exit
$ claude  # Restart
```

---

## 🎓 Best Practices

### 1. Division of Labor

**MADACE Handles:**

- ✅ Project planning (PRD, Epics)
- ✅ Story creation and prioritization
- ✅ Workflow orchestration (agents)
- ✅ State tracking (BACKLOG → DONE)
- ✅ Architecture decisions (ADRs)

**Claude Code Handles:**

- ✅ Code implementation
- ✅ Debugging and troubleshooting
- ✅ Code review and refactoring
- ✅ Test writing
- ✅ Git commit messages

### 2. Communication Pattern

**Sequential Flow (Recommended):**

```
MADACE (Planning) → Claude Code (Implementation) → MADACE (Review) → Repeat
```

**Parallel Flow (Advanced):**

```
MADACE (Story Management) ←──WebSocket Sync──→ Claude Code (Implementation)
         ↓                                               ↓
    Update TODO                                     Write Code
         ↓                                               ↓
    Track Progress ←─────────File System─────────→ Commit Changes
```

### 3. Commit Message Convention

**When using Claude Code with MADACE:**

```bash
# Claude Code auto-generates commits
# Format: [STORY-ID] Summary

Example:
[STORY-001] Implement user authentication

- Add login/register forms
- Integrate NextAuth.js
- Add protected routes
- Write E2E tests

🤖 Generated with Claude Code
```

### 4. Code Review Workflow

```bash
# 1. Implementation (Claude Code)
$ claude
> Implement STORY-001

# 2. Review (MADACE Web UI)
Navigate to /agents/dev
Review implementation against story acceptance criteria

# 3. Approval (MADACE)
Mark story as DONE → Moves to DONE column

# 4. Next Story (Automatic)
Next story from BACKLOG → TODO
Claude Code receives notification
```

---

## 🔮 Future Enhancements

### Phase 1: Enhanced Integration (v2.1)

- [ ] MADACE slash commands in Claude Code
- [ ] Bi-directional WebSocket sync (full duplex)
- [ ] Shared clipboard between tools
- [ ] Unified search across MADACE + Claude Code history

### Phase 2: Deep Integration (v3.0)

- [ ] Claude Code as MADACE agent (DEV agent uses Claude Code)
- [ ] Natural language story creation via Claude Code
- [ ] Automatic test generation synced with MADACE workflows
- [ ] Collaborative code review (MADACE Web UI + Claude Code CLI)

### Phase 3: AI Orchestration (v3.1)

- [ ] Multi-agent collaboration (MADACE agents + Claude Code)
- [ ] Workflow execution from Claude Code
- [ ] Agent memory shared between tools
- [ ] Voice commands for both tools

---

## 📚 Resources

### Documentation

- [MADACE README](../README.md) - MADACE overview
- [MADACE CLAUDE.md](../CLAUDE.md) - Development guide
- [Claude Code Docs](https://docs.claude.com/en/docs/claude-code) - Official docs

### Example Projects

- [MADACE v2.0](https://github.com/tekcin/MADACE-METHOD) - Built with MADACE + Claude Code
- See `docs/v3-planning/` - v3.0 planned with MADACE-Method

### Community

- GitHub Issues: Report integration bugs
- Discord: Share integration workflows
- Twitter: #MADACE #ClaudeCode

---

## ✅ Integration Checklist

Before starting a project with MADACE + Claude Code:

- [ ] Install MADACE (Docker or npm)
- [ ] Install Claude Code CLI
- [ ] Configure `.claude/settings.local.json` with MADACE permissions
- [ ] Set up `.env` with shared LLM API keys
- [ ] Start MADACE Web UI (`npm run dev` or `docker-compose up`)
- [ ] Test WebSocket sync (check port 3001)
- [ ] Create first story in MADACE
- [ ] Implement with Claude Code
- [ ] Verify real-time sync works

**Status: ✅ Integration Ready!**

---

**Maintained by:** MADACE Core Team
**Last Updated:** 2025-10-24
**Next Review:** 2025-11-01
